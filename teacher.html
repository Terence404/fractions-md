<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fractions Live Quiz — Teacher</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111a33; --panel2:#0f1730; --ink:#eaf0ff; --muted:#b9c6ff;
    --good:#5cffb5; --warn:#ffd56a; --bad:#ff6b8a; --line:rgba(255,255,255,.12);
    --radius:18px; --shadow:0 14px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial; background:radial-gradient(1000px 600px at 20% 0%, #182a5a 0%, var(--bg) 55%);
       color:var(--ink); min-height:100vh;}
  .wrap{max-width:1200px;margin:0 auto;padding:18px; display:grid; gap:14px; grid-template-columns: 420px 1fr;}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr;} }
  .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
        border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
  .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line); font-size:16px; letter-spacing:.2px;}
  .card .body{padding:14px 16px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input, textarea, select{width:100%; background:rgba(0,0,0,.22); color:var(--ink); border:1px solid var(--line);
         border-radius:12px; padding:10px 12px; outline:none;}
  textarea{min-height:160px;resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  button{border:1px solid var(--line); background:rgba(255,255,255,.08); color:var(--ink);
         padding:10px 12px; border-radius:12px; cursor:pointer}
  button.primary{background:rgba(92,255,181,.18); border-color:rgba(92,255,181,.35)}
  button.danger{background:rgba(255,107,138,.16); border-color:rgba(255,107,138,.35)}
  button:disabled{opacity:.55; cursor:not-allowed}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line);
        border-radius:999px; background:rgba(0,0,0,.18); font-size:12px; color:var(--muted)}
  .grid{display:grid; gap:12px}
  .qrBox{display:grid; grid-template-columns: 164px 1fr; gap:12px; align-items:center}
  canvas#qr{width:164px;height:164px; background:#fff; border-radius:12px}
  .leaderHead{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .toggle{display:flex; gap:8px; align-items:center}
  .table{width:100%; border-collapse:separate; border-spacing:0}
  .table th,.table td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px}
  .table th{color:var(--muted); font-weight:600; text-align:left; position:sticky; top:0; background:rgba(10,16,32,.65); backdrop-filter: blur(6px)}
  .rank{width:44px;color:var(--muted)}
  .score{font-weight:700}
  .ok{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Session setup</h2>
      <div class="body grid">
        <div class="pill">Status: <span id="authStatus" class="mono">Signing in…</span></div>

        <label>Class roster (one name per line)</label>
        <textarea id="roster" placeholder="e.g.\nAlicia Tan\nBen Lim\n..."></textarea>

        <div class="row">
          <div>
            <label>Time limit (minutes)</label>
            <input id="timeLimit" type="number" min="5" max="20" step="1" value="12" />
          </div>
          <div>
            <label>Wrong answer penalty (points)</label>
            <input id="wrongPenalty" type="number" min="0" max="100" step="5" value="20" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Leaderboard size (Top N)</label>
            <input id="topN" type="number" min="5" max="30" step="1" value="12" />
          </div>
          <div>
            <label>Session code length</label>
            <select id="codeLen">
              <option value="5">5</option>
              <option value="6" selected>6</option>
              <option value="7">7</option>
            </select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnStart">Start new session</button>
          <button id="btnCopy" disabled>Copy join link</button>
          <button class="danger" id="btnEnd" disabled>End session</button>
        </div>

        <div class="card" style="margin-top:10px">
          <h2>Join</h2>
          <div class="body">
            <div class="qrBox">
              <img id="qrImg" alt="QR code" style="width:280px;height:280px;background:#fff;border-radius:12px" />
              <div>
                <div class="small">Session code</div>
                <div id="sessionCode" class="mono" style="font-size:22px;margin:2px 0 8px">—</div>
                <div class="small">Join link</div>
                <div id="joinLink" class="mono" style="word-break:break-all; font-size:12px; opacity:.9">—</div>
                <div class="small" style="margin-top:8px">Tip: project this screen; students scan the QR and pick their name.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="small">Note: Students never need accounts; anonymous sign-in gives each device a unique ID.</div>
      </div>
    </div>

    <div class="card">
      <h2>Live leaderboard</h2>
      <div class="body">
        <div class="leaderHead">
          <div class="pill">Active session: <span id="activeSid" class="mono">—</span></div>
          <div class="toggle">
            <label class="small" style="margin:0">View:</label>
            <select id="viewMode">
              <option value="top">Top only</option>
              <option value="full">Full list</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px; max-height:70vh; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px">
          <table class="table">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>Name</th>
                <th>Status</th>
                <th style="width:110px">Score</th>
                <th style="width:90px">Done</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="5" class="small" style="padding:14px">No session yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px">
          Ranking: higher score first. Tie-break: more completed, then earlier end time (if finished).
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ---------- Firebase imports ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getDatabase, ref, set, update, get, onValue, remove, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // ======= PASTE YOUR FIREBASE CONFIG HERE (in BOTH files) =======
  const firebaseConfig = {

  apiKey: "AIzaSyBJA0S1lMftbIImWuIvrY84mtEZ3NeO-mA",

  authDomain: "multiply-and-divide-fractions.firebaseapp.com",

  databaseURL: "https://multiply-and-divide-fractions-default-rtdb.asia-southeast1.firebasedatabase.app",

  projectId: "multiply-and-divide-fractions",

  storageBucket: "multiply-and-divide-fractions.firebasestorage.app",

  messagingSenderId: "641613369936",

  appId: "1:641613369936:web:8ca6dbc66b015bf9087755"

};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const $ = (id)=>document.getElementById(id);

  const authStatus = $("authStatus");
  const btnStart = $("btnStart");
  const btnCopy = $("btnCopy");
  const btnEnd  = $("btnEnd");
  const rosterTA = $("roster");
  const timeLimit = $("timeLimit");
  const wrongPenalty = $("wrongPenalty");
  const topN = $("topN");
  const codeLen = $("codeLen");
  const sessionCodeEl = $("sessionCode");
  const joinLinkEl = $("joinLink");
  const activeSidEl = $("activeSid");
  const lbBody = $("lbBody");
  const viewMode = $("viewMode");

  let myUid = null;
  let sid = null;
  let unsubPlayers = null;
  let cachedPlayers = {};

  // ---------- Helpers ----------
  function randCode(len){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // avoid confusing chars
    let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  function parseRoster(){
    const lines = rosterTA.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    // de-dup while preserving order
    const seen=new Set(); const out=[];
    for(const n of lines){ if(!seen.has(n.toLowerCase())){ seen.add(n.toLowerCase()); out.push(n); } }
    return out;
  }

  // ---------- Minimal QR generator (Nayuki-style, compact) ----------
  // For classroom use: encode plain URL text. (This is a small QR implementation—no external libs.)
  // Source inspiration: Project Nayuki QR (public domain). Simplified for v1.

    // Tiny fallback: use browser built-in QR via Image API is not available offline, so we implement a simple QR.
    // This small encoder supports byte-mode text; error correction is modest but fine for short URLs.
    // To keep this file short, we use a minimal QR library-like routine.
    const qr = QrCode.encodeText(text, QrCode.Ecc.MEDIUM);
    const border = 2;
    const scale = Math.floor(Math.min(canvas.width, canvas.height) / (qr.size + border*2));
    const offsetX = Math.floor((canvas.width  - (qr.size + border*2)*scale)/2);
    const offsetY = Math.floor((canvas.height - (qr.size + border*2)*scale)/2);

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#000";
    for(let y=0;y<qr.size;y++){
      for(let x=0;x<qr.size;x++){
        if(qr.getModule(x,y)){
          ctx.fillRect(offsetX+(x+border)*scale, offsetY+(y+border)*scale, scale, scale);
        }
      }
    }

  // ---------- Auth ----------
  signInAnonymously(auth).catch(err=>{
    authStatus.textContent = "Auth error";
    console.error(err);
    alert("Firebase auth failed. Check Auth settings and allowed domains.");
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      myUid = user.uid;
      authStatus.textContent = "Signed in (anon)";
      btnStart.disabled = false;
    }
  });

  // ---------- Session start ----------
  btnStart.addEventListener("click", async ()=>{
    const names = parseRoster();
    if(names.length < 5){
      alert("Please paste your roster (at least 5 names).");
      return;
    }
    const minutes = Math.max(5, Math.min(20, Number(timeLimit.value||12)));
    const penalty = Math.max(0, Math.min(100, Number(wrongPenalty.value||20)));
    const top = Math.max(5, Math.min(30, Number(topN.value||12)));
    const cLen = Number(codeLen.value||6);

    sid = randCode(cLen);
    const joinUrl = new URL(location.href.replace(/teacher\.html.*/,"student.html"));
    joinUrl.searchParams.set("sid", sid);

    // write session
    const sessionRef = ref(db, `sessions/${sid}`);
    const payload = {
      teacherUid: myUid,
      public: {
        createdAt: serverTimestamp(),
        sid,
        timeLimitSec: minutes*60,
        wrongPenalty: penalty,
        topN: top,
        roster: names
      }
    };
    await set(sessionRef, payload);

    // Update UI
    $("activeSid").textContent = sid;
    sessionCodeEl.textContent = sid;
    joinLinkEl.textContent = joinUrl.toString();
    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=" + encodeURIComponent(joinUrl.toString());
document.getElementById("qrImg").src = qrUrl;
    btnCopy.disabled = false;
    btnEnd.disabled  = false;

    // Listen to players
    attachPlayersListener();
  });

  btnCopy.addEventListener("click", async ()=>{
    const t = joinLinkEl.textContent;
    if(!t || t==="—") return;
    try{
      await navigator.clipboard.writeText(t);
      btnCopy.textContent = "Copied!";
      setTimeout(()=>btnCopy.textContent="Copy join link", 900);
    }catch{
      alert("Copy failed. You can manually copy the join link.");
    }
  });

  btnEnd.addEventListener("click", async ()=>{
    if(!sid) return;
    if(!confirm("End session? This removes the session + leaderboard data.")) return;
    await remove(ref(db, `sessions/${sid}`));
    sid=null;
    cachedPlayers={};
    renderLeaderboard([]);
    $("activeSid").textContent="—";
    sessionCodeEl.textContent="—";
    joinLinkEl.textContent="—";
    document.getElementById("qrImg").removeAttribute("src");
    btnCopy.disabled=true;
    btnEnd.disabled=true;
  });

  function attachPlayersListener(){
    if(!sid) return;
    const playersRef = ref(db, `sessions/${sid}/players`);
    onValue(playersRef, (snap)=>{
      cachedPlayers = snap.val() || {};
      renderLeaderboard(Object.values(cachedPlayers));
    });
  }

  viewMode.addEventListener("change", ()=>renderLeaderboard(Object.values(cachedPlayers)));

  function renderLeaderboard(players){
    if(!players || players.length===0){
      lbBody.innerHTML = `<tr><td colspan="5" class="small" style="padding:14px">No players yet.</td></tr>`;
      return;
    }
    players.sort((a,b)=>{
      // score desc
      const ds=(b.score||0)-(a.score||0); if(ds!==0) return ds;
      // completed desc
      const dc=(b.completed||0)-(a.completed||0); if(dc!==0) return dc;
      // finished earlier first (if both finished)
      const af=a.endedAt||1e18, bf=b.endedAt||1e18;
      return af-bf;
    });

    const top = Number(topN.value||12);
    const show = (viewMode.value==="full") ? players : players.slice(0, top);

    lbBody.innerHTML = show.map((p, idx)=>{
      const st = p.status || "playing";
      const stClass = st==="finished" ? "ok" : st==="playing" ? "warn" : "bad";
      const done = `${p.completed||0}/10`;
      return `<tr>
        <td class="rank">${idx+1}</td>
        <td>${escapeHtml(p.name||"(no name)")}</td>
        <td class="${stClass}">${escapeHtml(st)}</td>
        <td class="score">${p.score||0}</td>
        <td>${done}</td>
      </tr>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>

</html>



