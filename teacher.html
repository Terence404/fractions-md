<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Teacher – Fractions Live Quiz</title>
<style>
  :root{
    --bg:#0b1020; --card:#111a33; --text:#eaf0ff; --muted:rgba(234,240,255,.72);
    --line:rgba(234,240,255,.14); --accent:#66d9ff; --bad:#ff6b6b;
    --shadow: 0 10px 28px rgba(0,0,0,.35); --radius:16px; --sidew: 420px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:radial-gradient(1200px 600px at 10% 0%, #1a2a5a 0%, #0b1020 55%, #060914 100%);color:var(--text);}
  .layout{display:grid;grid-template-columns: var(--sidew) 1fr;gap:14px;height:100vh;padding:14px;overflow:hidden;}
  .sidebar,.main{min-width:0;height:100%;overflow:hidden;}
  .stack{height:100%;display:flex;flex-direction:column;gap:14px;overflow:hidden;}
  .stack>.card{flex:0 0 auto;}
  .stack>.card.joinCard{flex:1 1 auto;overflow:hidden;display:flex;flex-direction:column;}
  .joinCard .body{overflow:auto;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
  .card h2{margin:0;padding:12px 14px;font-size:16px;letter-spacing:.2px;background:rgba(0,0,0,.18);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .body{padding:12px 14px}
  .grid{display:grid;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input, textarea, select{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(234,240,255,.16);background:rgba(0,0,0,.20);color:var(--text);outline:none;}
  textarea{resize:vertical;min-height:88px;max-height:140px}
  .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;color:#001018;background:var(--accent);box-shadow:0 10px 20px rgba(102,217,255,.18);}
  button.secondary{background:rgba(234,240,255,.12);color:var(--text);box-shadow:none;border:1px solid rgba(234,240,255,.16)}
  button.danger{background:var(--bad);color:#240000}
  button:disabled{opacity:.45;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(234,240,255,.16);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted);}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .hr{height:1px;background:var(--line); margin:10px 0}
  .joinCode{font-size:30px;font-weight:900;letter-spacing:1px;margin:0}
  .joinLinkBig{word-break:break-all;font-size:16px;line-height:1.25;padding:10px 12px;border:1px solid rgba(234,240,255,.14);border-radius:12px;background:rgba(0,0,0,.18);}
  .qrBox{background:#fff;border-radius:16px;border:12px solid #fff; /* quiet zone */ box-shadow:0 12px 24px rgba(0,0,0,.35);width:100%;max-width:360px;margin:8px 0;overflow:hidden;}
  canvas.qr{display:block;width:100%;height:auto;background:#fff;image-rendering:pixelated;}
  .topBar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
  .toggle{display:inline-flex;border:1px solid rgba(234,240,255,.16);border-radius:999px;overflow:hidden;background:rgba(0,0,0,.18);}
  .toggle button{box-shadow:none;padding:8px 10px;border-radius:0;background:transparent;color:var(--muted);font-weight:900;}
  .toggle button.active{background:rgba(102,217,255,.18);color:var(--text);}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px 8px;border-bottom:1px solid rgba(234,240,255,.10);text-align:left}
  th{color:var(--muted);font-weight:700;font-size:12px}
  .rank{width:44px;color:var(--muted)}
  .right{text-align:right}
  .score{font-weight:900}
  .offline{opacity:.55}
  .collapseBtn{background:rgba(234,240,255,.12);color:var(--text);border:1px solid rgba(234,240,255,.16);box-shadow:none;padding:8px 10px;border-radius:12px;font-weight:900;}
  body.collapsed .layout{grid-template-columns: 1fr;}
  body.collapsed .sidebar{display:none;}
  .restoreBtn{position:fixed;top:12px;left:12px;z-index:9999;display:none;background:rgba(234,240,255,.14);border:1px solid rgba(234,240,255,.20);color:var(--text);box-shadow:var(--shadow);}
  body.collapsed .restoreBtn{display:inline-flex;}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:16px;z-index:9998;}
  .modal.show{display:flex;}
  .modalBox{width:min(860px, 96vw);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;}
  .modalHead{padding:12px 14px;background:rgba(0,0,0,.18);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:900;}
  .modalBody{padding:14px}
  .qrBigWrap{display:flex;justify-content:center;}
  .qrBigBox{background:#fff;border-radius:18px;border:14px solid #fff;box-shadow:0 14px 28px rgba(0,0,0,.35);overflow:hidden;}
  canvas.qrBig{display:block;width:720px;height:720px;background:#fff;image-rendering:pixelated;}
  @media (max-width: 820px){ canvas.qrBig{ width:520px; height:520px; } }
  @media (max-width: 580px){ canvas.qrBig{ width:360px; height:360px; } }
  @media (max-width: 980px){
    :root{--sidew: 100%;}
    .layout{grid-template-columns:1fr;height:auto;overflow:auto}
    .sidebar,.main{height:auto}
    .stack{height:auto}
  }

  .exportWrap{ position:relative; display:inline-flex; }
  .exportMenu{ display:none; position:absolute; right:0; top:calc(100% + 8px); min-width:260px; background:rgba(15,22,36,0.98); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:8px; box-shadow:0 18px 50px rgba(0,0,0,0.45); z-index:200; }
  .exportMenu.open{ display:block; }
  .exportMenu .menuItem{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; border-radius:10px; color:#e9f0ff; cursor:pointer; font-size:14px; }
  .exportMenu .menuItem:hover{ background:rgba(120,160,255,0.18); }

</style>
</head>
<body>

<button class="collapseBtn restoreBtn" id="btnRestore">Show setup</button>

<div class="layout">
  <div class="sidebar">
    <div class="stack">
      <div class="card">
        <h2>
          <span>Session setup</span>
          <button class="collapseBtn" id="btnCollapse">Hide panel</button>
        </h2>
        <div class="body grid">
          <div class="pill">Status: <span id="authStatus" class="mono">Signing in…</span></div>
          <div class="pill">Session: <span id="sidPill" class="mono">—</span></div>

          <label>Class roster (one name per line)</label>
          <textarea id="roster"></textarea>

          <div class="btnRow">
            <button class="secondary" id="btnSaveRoster" disabled>Save roster</button>
            <button class="secondary" id="btnLoadRoster" disabled>Reload roster</button>
          </div>

          <div class="row">
            <div>
              <label>Time limit (minutes)</label>
              <input id="timeLimit" type="number" min="5" max="20" step="1" value="12" />
            </div>
            <div>
              <label>Wrong answer penalty (points)</label>
              <input id="wrongPenalty" type="number" min="0" max="120" step="5" value="20" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Leaderboard size (Top N)</label>
              <input id="topN" type="number" min="5" max="60" step="1" value="12" />
            </div>
            <div>
              <label>Session code length</label>
              <select id="codeLen">
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
              </select>
            </div>
          </div>

          <div class="btnRow">
            <button id="btnStart" disabled>Start new session</button>
            <button class="danger" id="btnEnd" disabled>End session</button>
          </div>

          <div class="small" id="setupHint"></div>
        </div>
      </div>

      <div class="card joinCard">
        <h2>Join</h2>
        <div class="body">
          <div class="small">Session code</div>
          <div id="sessionCode" class="mono joinCode">—</div>

          <div class="qrBox">
            <canvas id="qrSmall" class="qr" width="320" height="320"></canvas>
          </div>

          <div class="btnRow">
            <button class="secondary" id="btnQrFull" disabled>Full-screen QR</button>
            <button class="secondary" id="btnCopy" disabled>Copy link</button>
          </div>

          <div class="small" style="margin-top:10px">Join link</div>
          <div id="joinLink" class="mono joinLinkBig">—</div>

          <div class="small" id="joinHint"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card" style="height:100%; display:flex; flex-direction:column; overflow:hidden;">
      <h2>
        <span>Live leaderboard</span>
        <span class="small" id="lbStatus">—</span>
      </h2>
      <div class="body" style="flex:1 1 auto; overflow:hidden;">
        <div class="topBar">
          <div class="toggle">
            <button id="modeCurrent" class="active" type="button">Current</button>
            <button id="modeBest" type="button">Best</button>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <div class="pill" id="playersPill">Players: 0</div>
            <button class="secondary" id="btnShowAll" type="button">Show all</button>
            <div class="exportWrap">
              <button class="secondary" id="btnExport" type="button">Export ▾</button>
              <div id="exportMenu" class="exportMenu" aria-hidden="true">
                <button class="menuItem" id="exportLb" type="button">Export leaderboard (CSV)</button>
                <button class="menuItem" id="exportDetailed" type="button">Export detailed report (CSV)</button>
              </div>
            </div>

          </div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto; height: calc(100vh - 190px);">
          <table>
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>Name</th>
                <th>Status</th>
                <th class="right">Score</th>
                <th class="right">Answered</th>
                <th class="right">Last seen</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="6" class="muted">No session yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="qrModal" aria-hidden="true">
  <div class="modalBox">
    <div class="modalHead">
      <span>Scan to join</span>
      <button class="secondary" id="btnCloseModal" type="button">Close</button>
    </div>
    <div class="modalBody">
      <div class="qrBigWrap">
        <div class="qrBigBox">
          <canvas id="qrBig" class="qrBig" width="720" height="720"></canvas>
        </div>
      </div>
      <div class="small" style="margin-top:10px" id="modalLink"></div>
    </div>
  </div>
</div>


<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
  "apiKey": "AIzaSyBJA0S1lMftbIImWuIvrY84mtEZ3NeO-mA",
  "authDomain": "multiply-and-divide-fractions.firebaseapp.com",
  "databaseURL": "https://multiply-and-divide-fractions-default-rtdb.asia-southeast1.firebasedatabase.app",
  "projectId": "multiply-and-divide-fractions",
  "storageBucket": "multiply-and-divide-fractions.firebasestorage.app",
  "messagingSenderId": "641613369936",
  "appId": "1:641613369936:web:8ca6dbc66b015bf9087755"
};
  const $ = (id)=>document.getElementById(id);

  function downloadCsv(filename, csvText){
    // Add UTF-8 BOM so Excel opens correctly
    const blob = new Blob(["\uFEFF" + csvText], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  function csvEscape(v){
    const s = (v===null||v===undefined) ? "" : String(v);
    return /[",\\n\\r]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }

  function toCsv(rows){
    // Use CRLF for best Excel compatibility
    return rows.map(r=>r.map(csvEscape).join(",")).join("\r\n");
  }

  function fmtTime(ms){
    if(!ms) return "";
    try{ return new Date(ms).toLocaleString(); }catch(_){ return String(ms); }
  }


  const authStatus = $("authStatus");
  const rosterTA = $("roster");
  const timeLimit = $("timeLimit");
  const wrongPenalty = $("wrongPenalty");
  const topN = $("topN");
  const codeLen = $("codeLen");

  const btnStart = $("btnStart");
  const btnEnd = $("btnEnd");
  const btnCopy = $("btnCopy");
  const btnSaveRoster = $("btnSaveRoster");
  const btnLoadRoster = $("btnLoadRoster");
  const setupHint = $("setupHint");
  const joinHint = $("joinHint");

  const sidPill = $("sidPill");
  const sessionCodeEl = $("sessionCode");
  const joinLinkEl = $("joinLink");
  const lbBody = $("lbBody");
  const playersPill = $("playersPill");
  const btnShowAll = $("btnShowAll");
  const btnExport = $("btnExport");
  const exportMenu = $("exportMenu");
  const exportLb = $("exportLb");
  const exportDetailed = $("exportDetailed");
  const lbStatus = $("lbStatus");

  const btnCollapse = $("btnCollapse");
  const btnRestore = $("btnRestore");

  const qrSmall = $("qrSmall");
  const qrBig = $("qrBig");
  const btnQrFull = $("btnQrFull");
  const qrModal = $("qrModal");
  const btnCloseModal = $("btnCloseModal");
  const modalLink = $("modalLink");

  let app, auth, db;
  let myUid = "";
  let currentSid = "";
  let scoreMode = "current";
  let playersUnsub = null;
  let lastPlayersCache = {};
  let lastJoinUrl = "";

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
  function parseRoster(text){
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const n of lines){
      const key = n.toLowerCase();
      if(!seen.has(key)){ seen.add(key); out.push(n); }
    }
    return out;
  }
  function randCode(len){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s="";
    crypto.getRandomValues(new Uint32Array(len)).forEach(v=>{ s += chars[v % chars.length]; });
    return s;
  }
  function fmtLastSeen(ms){
    if(!ms) return "—";
    const diff = Math.max(0, Math.round((Date.now() - ms)/1000));
    if(diff < 5) return "now";
    if(diff < 60) return diff + "s";
    const m = Math.round(diff/60);
    if(m < 60) return m + "m";
    const h = Math.round(m/60);
    return h + "h";
  }

  // ===== QR generator (offline, robust for versions 1–10, ECC M, byte mode) =====
  // Important fix: the vertical scan direction per column pair MUST use the (right+1)&2 trick
  // (this was the cause of “QR not recognised”).
  class QrGen {
    static makeGfTables(){
      const exp = new Array(512).fill(0);
      const log = new Array(256).fill(0);
      let x = 1;
      for(let i=0;i<255;i++){ exp[i]=x; log[x]=i; x<<=1; if(x&0x100) x ^= 0x11D; }
      for(let i=255;i<512;i++) exp[i]=exp[i-255];
      return {exp,log};
    }
    static GF = QrGen.makeGfTables();
    static gfMul(a,b){ if(a===0||b===0) return 0; const gf=QrGen.GF; return gf.exp[gf.log[a]+gf.log[b]]; }
    static polyMul(p,q){
      const out=new Array(p.length+q.length-1).fill(0);
      for(let i=0;i<p.length;i++) for(let j=0;j<q.length;j++) out[i+j] ^= QrGen.gfMul(p[i],q[j]);
      return out;
    }
    static rsGenerator(deg){
      let g=[1];
      for(let i=0;i<deg;i++) g = QrGen.polyMul(g,[1, QrGen.GF.exp[i]]);
      return g;
    }
    static rsRemainder(data, deg){
      const gen = QrGen.rsGenerator(deg);
      const res = new Array(deg).fill(0);
      for(const b of data){
        const factor = b ^ res.shift();
        res.push(0);
        for(let i=0;i<deg;i++) res[i] ^= QrGen.gfMul(gen[i+1], factor);
      }
      return res;
    }
    static bchFormatBits(data){
      let rem = data << 10;
      const gen = 0x537;
      for(let i=14;i>=10;i--) if(((rem>>>i)&1)!==0) rem ^= gen << (i-10);
      return ((data<<10) | rem) ^ 0x5412;
    }
    static bchVersionBits(ver){
      let rem = ver << 12;
      const gen = 0x1F25;
      for(let i=17;i>=12;i--) if(((rem>>>i)&1)!==0) rem ^= gen << (i-12);
      return (ver<<12) | (rem & 0xFFF);
    }
    static getNumDataCodewords(ver){ // ECC M only
      const table = {1:16,2:28,3:44,4:64,5:86,6:108,7:124,8:154,9:182,10:216};
      return table[ver];
    }
    static getRsParams(ver){ // ECC M only: [eccPerBlock, numBlocks]
      const table = {1:[10,1],2:[16,1],3:[26,1],4:[18,2],5:[24,2],6:[16,4],7:[18,4],8:[22,4],9:[22,5],10:[26,5]};
      return table[ver];
    }
    static alignmentPositions(ver){
      if(ver===1) return [];
      const table = {
        2:[6,18],3:[6,22],4:[6,26],5:[6,30],6:[6,34],
        7:[6,22,38],8:[6,24,42],9:[6,26,46],10:[6,28,50]
      };
      return table[ver] || [];
    }
    static chooseVersion(bytes){
      for(let ver=1;ver<=10;ver++){
        const capBits = QrGen.getNumDataCodewords(ver)*8;
        const ccbits = (ver<=9)?8:16;
        const need = 4 + ccbits + bytes.length*8;
        if(need <= capBits) return ver;
      }
      throw new Error("Text too long for versions 1–10");
    }
    static makeDataCodewords(text){
      const bytes = new TextEncoder().encode(text);
      const ver = QrGen.chooseVersion(bytes);
      const capBits = QrGen.getNumDataCodewords(ver)*8;
      const ccbits = (ver<=9)?8:16;

      const bits=[];
      const appendBits=(val,len)=>{ for(let i=len-1;i>=0;i--) bits.push(((val>>>i)&1)===1); };
      appendBits(0b0100,4); // byte mode
      appendBits(bytes.length, ccbits);
      for(const b of bytes) appendBits(b,8);

      appendBits(0, Math.min(4, capBits - bits.length));
      while(bits.length%8!==0) appendBits(0,1);
      const pad=[0xEC,0x11]; let k=0;
      while(bits.length < capBits){ appendBits(pad[k%2],8); k++; }

      const out=[];
      for(let i=0;i<bits.length;i+=8){
        let v=0;
        for(let j=0;j<8;j++) v = (v<<1) | (bits[i+j]?1:0);
        out.push(v);
      }
      return {ver, data: out};
    }
    static addEccAndInterleave(ver, data){
      const [eccPerBlock, numBlocks] = QrGen.getRsParams(ver);
      const blocks=[];
      const shortLen = Math.floor(data.length/numBlocks);
      const numLong = data.length % numBlocks;
      let k=0;
      for(let b=0;b<numBlocks;b++){
        const len = shortLen + (b<numLong?1:0);
        blocks.push(data.slice(k,k+len));
        k+=len;
      }
      const eccBlocks = blocks.map(bl=>QrGen.rsRemainder(bl, eccPerBlock));
      const out=[];
      const maxLen = shortLen + 1;
      for(let i=0;i<maxLen;i++) for(const bl of blocks) if(i<bl.length) out.push(bl[i]);
      for(let i=0;i<eccPerBlock;i++) for(const eb of eccBlocks) out.push(eb[i]);
      return out;
    }

    static makeModules(text){
      const {ver, data} = QrGen.makeDataCodewords(text);
      const n = ver*4 + 17;
      const mod = Array.from({length:n}, ()=>Array(n).fill(null));
      const isF = Array.from({length:n}, ()=>Array(n).fill(false));
      const setF = (x,y,v)=>{ mod[y][x]=v; isF[y][x]=true; };

      const drawFinder=(x,y)=>{
        for(let dy=-4;dy<=4;dy++) for(let dx=-4;dx<=4;dx++){
          const xx=x+dx, yy=y+dy;
          if(0<=xx&&xx<n&&0<=yy&&yy<n){
            const dist=Math.max(Math.abs(dx),Math.abs(dy));
            setF(xx,yy, dist!==2 && dist!==4);
          }
        }
      };
      const drawAlign=(x,y)=>{
        for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++) {
          setF(x+dx, y+dy, Math.max(Math.abs(dx),Math.abs(dy)) !== 1);
        }
      };

      drawFinder(3,3); drawFinder(n-4,3); drawFinder(3,n-4);

      // timing
      for(let i=0;i<n;i++){
        if(!isF[6][i]) setF(i,6, i%2===0);
        if(!isF[i][6]) setF(6,i, i%2===0);
      }

      // alignment
      const pos = QrGen.alignmentPositions(ver);
      for(const yy of pos) for(const xx of pos){
        const inTL = (xx===6 && yy===6);
        const inTR = (xx===n-7 && yy===6);
        const inBL = (xx===6 && yy===n-7);
        if(inTL||inTR||inBL) continue;
        drawAlign(xx,yy);
      }

      // dark module
      setF(8, n-8, true);

      // reserve format areas
      for(let i=0;i<9;i++){ isF[8][i]=true; isF[i][8]=true; }
      for(let i=n-8;i<n;i++){ isF[8][i]=true; isF[i][8]=true; }
      isF[8][n-8]=true;

      // version info (ver >= 7)
      if(ver >= 7){
        const vb = QrGen.bchVersionBits(ver);
        for(let i=0;i<18;i++){
          const bit = ((vb>>>i)&1)!==0;
          const a = n - 11 + (i % 3);
          const b = Math.floor(i / 3);
          setF(a, b, bit);
          setF(b, a, bit);
        }
      }

      // codewords
      const all = QrGen.addEccAndInterleave(ver, data);
      let bitIndex = 0;
      for(let right=n-1; right>=1; right-=2){
        if(right===6) right--;
        for(let vert=0; vert<n; vert++){
          // ***** CRITICAL: correct scan direction *****
          const upward = (((right + 1) & 2) === 0);
          const y = upward ? (n - 1 - vert) : vert;

          for(let j=0;j<2;j++){
            const x = right - j;
            if(isF[y][x]) continue;
            const cw = all[bitIndex>>>3];
            const bit = (cw >>> (7-(bitIndex&7))) & 1;
            mod[y][x] = bit===1;
            bitIndex++;
          }
        }
      }

      // mask 0 (x+y even)
      for(let y=0;y<n;y++) for(let x=0;x<n;x++){
        if(isF[y][x]) continue;
        if(((x+y)&1)===0) mod[y][x] = !mod[y][x];
      }

      // format bits: ECC M (00) + mask 0
      const fmt = QrGen.bchFormatBits(0b00000);
      const fmtBit = (i)=>((fmt>>>i)&1)!==0;
      for(let i=0;i<=5;i++) setF(8,i, fmtBit(i));
      setF(8,7, fmtBit(6));
      setF(8,8, fmtBit(7));
      setF(7,8, fmtBit(8));
      for(let i=9;i<15;i++) setF(14-i,8, fmtBit(i));
      for(let i=0;i<8;i++) setF(n-1-i,8, fmtBit(i));
      for(let i=8;i<15;i++) setF(8, n-15+i, fmtBit(i));
      setF(8, n-8, true);

      for(let y=0;y<n;y++) for(let x=0;x<n;x++) if(mod[y][x]===null) mod[y][x]=false;
      return {n, mod};
    }
  }

  function syncCanvasToCss(canvas){
    const rect = canvas.getBoundingClientRect();
    const size = Math.max(220, Math.floor(Math.min(rect.width, rect.height)));
    if(canvas.width !== size || canvas.height !== size){ canvas.width=size; canvas.height=size; return true; }
    return false;
  }

  function renderQr(canvas, text){
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    const qr = QrGen.makeModules(text);
    const quiet = 4;
    const size = qr.n + quiet*2;
    const scale = Math.max(1, Math.floor(canvas.width / size));
    const drawSize = size * scale;
    const ox = Math.floor((canvas.width - drawSize)/2);
    const oy = Math.floor((canvas.height - drawSize)/2);

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#000";
    for(let y=0;y<qr.n;y++) for(let x=0;x<qr.n;x++) if(qr.mod[y][x]){
      ctx.fillRect(ox+(x+quiet)*scale, oy+(y+quiet)*scale, scale, scale);
    }
  }

  // --- collapse ---
  const setCollapsed = (v)=>document.body.classList.toggle("collapsed", v);
  btnCollapse.addEventListener("click", ()=>setCollapsed(true));
  btnRestore.addEventListener("click", ()=>setCollapsed(false));

  // --- score mode ---
  const modeCurrentBtn = $("modeCurrent");
  const modeBestBtn = $("modeBest");
  function setMode(m){
    scoreMode=m;
    modeCurrentBtn.classList.toggle("active", m==="current");
    modeBestBtn.classList.toggle("active", m==="best");
    renderLeaderboard(lastPlayersCache);
  }
  modeCurrentBtn.addEventListener("click", ()=>setMode("current"));
  modeBestBtn.addEventListener("click", ()=>setMode("best"));


  // --- Show all toggle (uses existing button in header) ---
  let showAllActive = false;
  let prevTopNValue = null;

  function countNamedPlayers(playersObj){
    let c = 0;
    for(const p of Object.values(playersObj || {})){
      if(p && typeof p === "object" && String(p.name || "").trim()) c++;
    }
    return c;
  }

  function setShowAllLabel(){
    if(!btnShowAll) return;
    if(showAllActive){
      const backN = prevTopNValue || 12;
      btnShowAll.textContent = `Back to Top ${backN}`;
    }else{
      btnShowAll.textContent = "Show all";
    }
  }

  function toggleShowAll(){
    if(!currentSid) return;
    const count = countNamedPlayers(lastPlayersCache) || Object.keys(lastPlayersCache || {}).length || 1;
    if(!showAllActive){
      prevTopNValue = Number(topN.value || 12) || 12;
      topN.value = String(Math.max(1, count));
      showAllActive = true;
    }else{
      topN.value = String(prevTopNValue || 12);
      showAllActive = false;
    }
    setShowAllLabel();
    renderLeaderboard(lastPlayersCache);
  }

  if(btnShowAll){
    btnShowAll.addEventListener("click", toggleShowAll);

  // ---------- Export dropdown ----------
  function closeExportMenu(){ if(exportMenu){ exportMenu.classList.remove('open'); exportMenu.setAttribute('aria-hidden','true'); } }
  function toggleExportMenu(){
    if(!exportMenu) return;
    const isOpen = exportMenu.classList.toggle('open');
    exportMenu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
  }

  if(btnExport){
    btnExport.addEventListener('click', (e)=>{ e.stopPropagation(); toggleExportMenu(); });
    document.addEventListener('click', ()=>closeExportMenu());
  }
  if(exportMenu){ exportMenu.addEventListener('click', (e)=>e.stopPropagation()); }

  if(exportLb){
    exportLb.addEventListener('click', ()=>{ closeExportMenu(); exportLeaderboardCsv(); });
  }
  if(exportDetailed){
    exportDetailed.addEventListener('click', async ()=>{ closeExportMenu(); await exportDetailedCsv(); });
  }

  function exportLeaderboardCsv(){
    if(!currentSid){ alert("Start a session first."); return; }
    (async ()=>{
      try{
        const snap = await get(ref(db, `sessions/${currentSid}/players`));
        const players = snap.exists() ? snap.val() : {};
        const entries = Object.entries(players).map(([uid,p])=>({uid, ...(p||{})}));
        // Sort by BestScore (descending), then CurrentScore
        entries.sort((a,b)=> (b.bestScore||0)-(a.bestScore||0) || (b.currentScore||0)-(a.currentScore||0));
        const rows = [["Name","UID","CurrentScore","BestScore","Answered","Status","LastSeen"]];
        for(const p of entries){
          rows.push([
            p.name||"",
            p.uid||"",
            p.currentScore||0,
            p.bestScore||0,
            p.answered||0,
            p.status||"",
            p.lastSeen ? new Date(p.lastSeen).toLocaleString() : ""
          ]);
        }
        const csvText = toCsv(rows);
        downloadCsv(`leaderboard_${currentSid}.csv`, csvText);
      }catch(e){
        console.error(e);
        alert("Leaderboard export failed.");
      }
    })();
  }

  async function exportDetailedCsv(){
    if(!currentSid){ alert("Start a session first."); return; }
    lbStatus.textContent = "Exporting detailed report…";
    try{
      const [playersSnap, attemptsSnap] = await Promise.all([
        get(ref(db, `sessions/${currentSid}/players`)),
        get(ref(db, `sessions/${currentSid}/attempts`))
      ]);
      const players = playersSnap.exists() ? playersSnap.val() : {};
      const all = attemptsSnap.exists() ? attemptsSnap.val() : {};

      const rows = [[
        "Name","UID","QIndex","Attempt","Correct","TimeTakenSec","Type","Payload",
        "Whole","Num","Den","ParsedN","ParsedD","At"
      ]];

      for(const uid in all){
        const perUser = all[uid] || {};
        const name = (players[uid] && players[uid].name) ? players[uid].name : "";
        const recs = Object.values(perUser);
        recs.sort((a,b)=> (a.at||0)-(b.at||0));
        for(const r of recs){
          rows.push([
            name,
            uid,
            (r.qIndex ?? ""),
            (r.attempt ?? ""),
            (r.correct ? "1" : "0"),
            String(Math.round((r.timeTakenMs||0)/1000)),
            (r.type || ""),
            (r.payload ? JSON.stringify(r.payload) : ""),
            (r.submitted && r.submitted.whole != null ? r.submitted.whole : ""),
            (r.submitted && r.submitted.num != null ? r.submitted.num : ""),
            (r.submitted && r.submitted.den != null ? r.submitted.den : ""),
            (r.parsed && r.parsed.n != null ? r.parsed.n : ""),
            (r.parsed && r.parsed.d != null ? r.parsed.d : ""),
            (r.at ? new Date(r.at).toLocaleString() : "")
          ]);
        }
      }

      if(rows.length === 1){
        // No attempts logged
        rows.push(["","","","","","","","","","","","","",""]);
      }

      const csvText = toCsv(rows);
      downloadCsv(`detailed_${currentSid}.csv`, csvText);
    }catch(e){
      console.error(e);
      alert("Detailed export failed. Check Firebase rules allow teacher to read sessions/<sid>/attempts.");
    }finally{
      lbStatus.textContent = "";
    }
  }

{
    if(!currentSid){ alert('Start a session first.'); return; }
    lbStatus.textContent = 'Exporting detailed report…';
    try{
      const snap = await db.ref(`sessions/${currentSid}/attempts`).once('value');
      const all = snap.val() || {};
      const rows = [[
        'Name','UID','QIndex','Attempt','Correct','TimeTakenSec','Type','Payload','Whole','Num','Den','ParsedN','ParsedD','At'
      ]];
      for(const uid of Object.keys(all)){
        const perUser = all[uid] || {};
        const name = (lastPlayersCache && lastPlayersCache[uid] && lastPlayersCache[uid].name) ? lastPlayersCache[uid].name : '';
        const recs = listValues(perUser);
        recs.sort((a,b)=>(a.at||0)-(b.at||0));
        for(const r of recs){
          rows.push([
            name,
            uid,
            r.qIndex ?? '',
            r.attempt ?? '',
            r.correct ? '1' : '0',
            Math.round((r.timeTakenMs||0)/1000),
            r.type || '',
            r.payload ? JSON.stringify(r.payload) : '',
            (r.submitted && r.submitted.whole) ? r.submitted.whole : '',
            (r.submitted && r.submitted.num) ? r.submitted.num : '',
            (r.submitted && r.submitted.den) ? r.submitted.den : '',
            (r.parsed && r.parsed.n!=null) ? r.parsed.n : '',
            (r.parsed && r.parsed.d!=null) ? r.parsed.d : '',
            fmtTime(r.at)
          ]);
        }
      }
      downloadCsv(`detailed_${currentSid}.csv`, toCsv(rows));
    }catch(e){
      console.error(e);
      alert('Detailed export failed. Check RTDB rules allow teacher to read sessions/<sid>/attempts.');
    }finally{
      lbStatus.textContent = '—';
    }
  }

  }

  // If user manually changes Top N, exit show-all mode
  topN.addEventListener("change", ()=>{
    if(showAllActive){
      showAllActive = false;
      setShowAllLabel();
    }
  });

  // --- firebase init (compat) ---
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.database();

  // compat-style helpers to keep the rest of the code similar
  const ref = (db, path)=> db.ref(path);
  const set = (r, v)=> r.set(v);
  const update = (r, v)=> r.update(v);
  const get = async (r)=> await r.once("value");
  const onValue = (r, cb)=>{ r.on("value", cb); return ()=>r.off("value", cb); };
  auth.onAuthStateChanged(async (user)=>{
    if(user){
      myUid=user.uid;
      authStatus.textContent="Signed in (anon)";
      btnStart.disabled=false;
      btnSaveRoster.disabled=false;
      btnLoadRoster.disabled=false;
      await loadRoster();
    } else {
      myUid="";
      authStatus.textContent="Signing in…";
    }
  });
  auth.signInAnonymously().catch(err=>{
    authStatus.textContent="Auth error";
    setupHint.textContent="Auth error: " + (err?.code || err?.message || String(err));
    console.error(err);
  });

  async function loadRoster(){
    try{
      const snap = await get(ref(db, `teachers/${myUid}/roster/default`));
      if(snap.exists()){
        const arr = snap.val() || [];
        if(Array.isArray(arr) && arr.length) {
          rosterTA.value = arr.join("\n");
          setupHint.textContent = `Loaded saved roster (${arr.length} names).`;
        } else setupHint.textContent="Saved roster is empty.";
      } else setupHint.textContent="No saved roster yet. Paste names and click Save roster.";
    }catch(e){ console.error(e); setupHint.textContent="Could not load saved roster."; }
  }
  btnLoadRoster.addEventListener("click", loadRoster);

  btnSaveRoster.addEventListener("click", async ()=>{
    try{
      const roster = parseRoster(rosterTA.value);
      if(!roster.length){ setupHint.textContent="Roster is empty."; return; }
      await set(ref(db, `teachers/${myUid}/roster/default`), roster);
      setupHint.textContent = `Roster saved (${roster.length} names).`;
    }catch(e){ console.error(e); setupHint.textContent="Could not save roster."; }
  });
  function stopPlayersListener(){ if(playersUnsub){ playersUnsub(); playersUnsub=null; } }
  function listenPlayers(sid){
    stopPlayersListener();
    const playersRef = ref(db, `sessions/${sid}/players`);
    const unsub = onValue(playersRef, (snap)=>{
lastPlayersCache = snap.exists()? (snap.val()||{}) : {};
      renderLeaderboard(lastPlayersCache);
      lbStatus.textContent = `Players: ${Object.keys(lastPlayersCache||{}).length}`;
      if(playersPill) playersPill.textContent = `Players: ${Object.keys(lastPlayersCache||{}).length}`;
    });
    playersUnsub = unsub;
}

  function renderLeaderboard(playersObj){
    const rows=[];
    for(const [uid,p] of Object.entries(playersObj||{})){
      if(!p || typeof p!=="object") continue;
      const name=(p.name||"").trim();
      if(!name) continue;
      const cur=Number(p.currentScore ?? p.score ?? 0);
      const best=Number(p.bestScore ?? 0);
      const metric=(scoreMode==="best")?best:cur;
      const answered=Number(p.answered ?? p.completed ?? 0);
      const status=String(p.status||"").trim() || "playing";
      const lastSeen=(typeof p.lastSeen==="number")?p.lastSeen:null;
      const leftAt=(typeof p.leftAt==="number")?p.leftAt:null;
      rows.push({uid,name,cur,best,metric,answered,status,lastSeen,leftAt});
    }
    rows.sort((a,b)=>{ if(b.metric!==a.metric) return b.metric-a.metric; if(b.answered!==a.answered) return b.answered-a.answered; return a.name.localeCompare(b.name); });

    const n = Math.max(1, Math.min(999, Number(topN.value||12)));
    const view = rows.slice(0,n);

    if(!currentSid){ lbBody.innerHTML = `<tr><td colspan="6" class="muted">No session yet.</td></tr>`; return; }
    if(!view.length){ lbBody.innerHTML = `<tr><td colspan="6" class="muted">No players yet.</td></tr>`; return; }

    const now = Date.now();
    const badge = (status, stale)=>{
      const s = (status||"playing").toLowerCase();
      let label = s;
      let color = "rgba(234,240,255,.72)";
      if(s==="lobby") { label="lobby"; color="rgba(255,213,106,.95)"; }
      else if(s==="playing") { label = stale?"offline":"playing"; color="rgba(102,217,255,.95)"; }
      else if(s==="finished") { label="finished"; color="rgba(92,255,181,.95)"; }
      else if(s==="timeup") { label="time up"; color="rgba(255,213,106,.95)"; }
      else if(s==="left") { label="left"; color="rgba(255,107,107,.95)"; }
      return `<span class="mono" style="font-size:12px; font-weight:900; color:${color}">${escapeHtml(label)}</span>`;
    };

    lbBody.innerHTML = view.map((p,i)=>{
      const seen = p.lastSeen || p.leftAt;
      const stale = !!(seen && (now-seen)>45000);
      const offlineRow = stale && p.status!=="left";
      const score = (scoreMode==="best")?p.best:p.cur;
      const lastText = (String(p.status||"").toLowerCase()==="left")
        ? (p.leftAt? `Left ${fmtLastSeen(p.leftAt)}` : `Left ${fmtLastSeen(p.lastSeen)}`)
        : fmtLastSeen(p.lastSeen);
      return `
        <tr class="${offlineRow?'offline':''}">
          <td class="rank">${i+1}</td>
          <td><strong>${escapeHtml(p.name)}</strong></td>
          <td>${badge(p.status, stale)}</td>
          <td class="right score">${score}</td>
          <td class="right">${p.answered}</td>
          <td class="right">${lastText}</td>
        </tr>
      `;
    }).join("");
  }

  function makeJoinUrl(sid){
    const u = new URL(location.href);
    u.pathname = u.pathname.replace(/teacher\.html$/i, "student.html");
    u.search = "?sid=" + encodeURIComponent(sid);
    return u.toString();
  }

  function updateJoinDisplay(sid){
    currentSid = sid || "";
    sidPill.textContent = currentSid || "—";
    sessionCodeEl.textContent = currentSid || "—";

    if(!currentSid){
      joinLinkEl.textContent="—";
      btnCopy.disabled=true;
      btnQrFull.disabled=true;
      lastJoinUrl="";
      const ctx = qrSmall.getContext("2d"); ctx.fillStyle="#fff"; ctx.fillRect(0,0,qrSmall.width, qrSmall.height);
      const ctx2 = qrBig.getContext("2d"); ctx2.fillStyle="#fff"; ctx2.fillRect(0,0,qrBig.width, qrBig.height);
      return;
    }

    lastJoinUrl = makeJoinUrl(currentSid);
    joinLinkEl.textContent = lastJoinUrl;
    modalLink.textContent = lastJoinUrl;
    btnCopy.disabled=false;
    btnQrFull.disabled=false;

    syncCanvasToCss(qrSmall);
    renderQr(qrSmall, lastJoinUrl);
    renderQr(qrBig, lastJoinUrl);
  }

  const ro = new ResizeObserver(()=>{
    if(!lastJoinUrl) return;
    const changed = syncCanvasToCss(qrSmall);
    if(changed) renderQr(qrSmall, lastJoinUrl);
  });
  ro.observe(qrSmall);

  btnCopy.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(joinLinkEl.textContent); joinHint.textContent="Copied."; setTimeout(()=>joinHint.textContent="", 1200); }
    catch{ joinHint.textContent="Copy failed. Select the link text and copy."; }
  });

  btnQrFull.addEventListener("click", ()=>{
    if(!lastJoinUrl) return;
    qrModal.classList.add("show");
    qrModal.setAttribute("aria-hidden","false");
    renderQr(qrBig, lastJoinUrl);
  });
  btnCloseModal.addEventListener("click", ()=>{ qrModal.classList.remove("show"); qrModal.setAttribute("aria-hidden","true"); });
  qrModal.addEventListener("click", (e)=>{ if(e.target===qrModal){ qrModal.classList.remove("show"); qrModal.setAttribute("aria-hidden","true"); } });

  btnStart.addEventListener("click", async ()=>{
    setupHint.textContent=""; joinHint.textContent="";
    const roster = parseRoster(rosterTA.value);
    if(roster.length<1){ setupHint.textContent="Roster is empty. Add at least 1 name."; return; }

    const minutes = Math.max(5, Math.min(20, Number(timeLimit.value||12)));
    const wrong = Math.max(0, Math.min(120, Number(wrongPenalty.value||20)));
    const len = Math.max(5, Math.min(7, Number(codeLen.value||6)));
    const sid = randCode(len);

    try{
      await set(ref(db, `teachers/${myUid}/roster/default`), roster);

      const pub = {
        active:true,
        createdAt: Date.now(),
        timeLimitSec: minutes*60,
        wrongPenalty: wrong,
        roster: roster
      };

      await set(ref(db, `sessions/${sid}/teacherUid`), myUid);
      await set(ref(db, `sessions/${sid}/public`), pub);
      await set(ref(db, `teachers/${myUid}/sessions/${sid}`), { createdAt: pub.createdAt });

      btnStart.disabled=true;
      btnEnd.disabled=false;

      updateJoinDisplay(sid);
      listenPlayers(sid);
      setupHint.textContent = `Session started. Roster uploaded: ${roster.length} names.`;
    } catch(e){ console.error(e); setupHint.textContent="Failed to start session. Check console / database rules."; }
  });

  btnEnd.addEventListener("click", async ()=>{
    if(!currentSid) return;
    try{ await update(ref(db, `sessions/${currentSid}/public`), { active:false, endedAt: Date.now() }); setupHint.textContent="Session ended. Leaderboard remains visible."; }
    catch(e){ console.error(e); setupHint.textContent="Failed to end session."; }
    btnStart.disabled=false;
    btnEnd.disabled=true;
  });

  updateJoinDisplay("");
</script>
</body>
</html>

