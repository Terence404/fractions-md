<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student – Fractions Live Quiz</title>
<style>
  :root{
    --bg:#071025;
    --panel:#0f1b3b;
    --panel2:#0c1633;
    --text:#eaf0ff;
    --muted:rgba(234,240,255,.72);
    --line:rgba(234,240,255,.14);
    --accent:#66d9ff;
    --good:#66ff99;
    --bad:#ff6b6b;
    --shadow: 0 10px 28px rgba(0,0,0,.35);
    --radius:18px;

    --boxBg: rgba(255,255,255,.08);
    --boxBorder: rgba(234,240,255,.20);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,Segoe UI,Arial,sans-serif;
    background:radial-gradient(1200px 600px at 10% 0%, #1a2a5a 0%, #071025 55%, #050813 100%);
    color:var(--text);
    min-height:100vh;
    display:flex;
    justify-content:center;
  }
  .wrap{
    width:min(980px, 96vw);
    padding:14px 0 22px;
  }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card h1{
    margin:0; padding:14px 16px;
    font-size:18px;
    background:rgba(0,0,0,.18);
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .body{padding:14px 16px}
  .muted{color:var(--muted)}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid rgba(234,240,255,.16);
    background:rgba(0,0,0,.18);
    font-size:12px; color:var(--muted);
  }
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  button{
    border:0; border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
    color:#001018;
    background:var(--accent);
    box-shadow:0 10px 20px rgba(102,217,255,.18);
  }
  button.secondary{background:rgba(234,240,255,.12); color:var(--text); box-shadow:none; border:1px solid rgba(234,240,255,.16)}
  button:disabled{opacity:.45; cursor:not-allowed}
  .hr{height:1px;background:var(--line); margin:12px 0}

  /* Join modal */
  .modal{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    padding:16px;
    z-index:50;
  }
  .modalBox{
    width:min(520px, 94vw);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding:14px 16px;
    background:rgba(0,0,0,.18);
    border-bottom:1px solid var(--line);
    font-weight:900;
  }
  .modalBody{padding:14px 16px}
  select{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(234,240,255,.16);
    background:rgba(0,0,0,.22);
    color:var(--text);
    outline:none;
    font-size:14px;
  }
  .hint{font-size:12px;color:var(--muted); margin-top:8px; min-height:16px}

  /* Question display */
  .qBox{
    display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;
    padding:12px 12px;
    border:1px solid rgba(234,240,255,.14);
    border-radius:16px;
    background:rgba(0,0,0,.18);
  }
  .qText{
    font-size:26px;
    font-weight:900;
    letter-spacing:.2px;
    display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
  }
  .frac{
    display:inline-grid;
    grid-template-rows:auto 3px auto;
    align-items:center;
    justify-items:center;
    line-height:1;
    min-width: 36px;
    margin:0 2px;
  }
  .frac .bar{height:3px; width:100%; background:rgba(234,240,255,.78); border-radius:3px}
  .frac .top,.frac .bot{font-size:.78em}
  .mixed{
    display:inline-flex; align-items:center; gap:6px;
  }

  /* Answer area - mixed-number look */
  .answerArea{
    display:flex; align-items:flex-end; gap:14px; flex-wrap:wrap;
    margin-top:12px;
  }
  .ansMixed{
    display:inline-flex;
    align-items:flex-end;
    gap:12px;
  }
  .box{
    min-width:92px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--boxBorder);
    background:var(--boxBg);
    text-align:center;
    font-weight:900;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    user-select:none;
  }
  .box.active{
    outline:3px solid rgba(102,217,255,.45);
    border-color: rgba(102,217,255,.60);
  }
  .boxWhole{
    min-width:96px;
    padding:14px 14px;
    font-size:34px;
    border-radius:18px;
  }
  .fracInputs{
    display:grid;
    grid-template-rows:auto 4px auto;
    align-items:center;
    justify-items:stretch;
    gap:6px;
    width:110px;
  }
  .boxSmall{
    min-width:110px;
    padding:8px 10px;
    font-size:22px;
    border-radius:16px;
  }
  .fracBar2{
    height:4px;
    background:rgba(234,240,255,.78);
    border-radius:3px;
  }

  .simplestLine{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
  }

  /* Keypad */
  .padWrap{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .pad{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
  }
  .k{
    padding:12px 0;
    border-radius:14px;
    background:rgba(234,240,255,.10);
    border:1px solid rgba(234,240,255,.14);
    color:var(--text);
    font-weight:900;
    text-align:center;
    user-select:none;
    cursor:pointer;
  }
  .k:active{transform:translateY(1px)}
  .k.wide{grid-column: span 2}
  .k.bad{background:rgba(255,107,107,.20); border-color:rgba(255,107,107,.35)}
  .k.good{background:rgba(102,255,153,.18); border-color:rgba(102,255,153,.30)}

  /* Feedback */
  .toast{
    margin-top:10px;
    min-height:22px;
    font-weight:800;
  }
  .toast.good{color:var(--good)}
  .toast.bad{color:var(--bad)}

  @media (max-width: 560px){
    .qText{font-size:22px}
    .box{min-width:74px}
    .boxWhole{min-width:76px; font-size:30px}
    .fracInputs{width:92px}
    .boxSmall{min-width:92px; font-size:20px}
    .pad{grid-template-columns: repeat(4, 1fr)}
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>
      <span>Multiply & Divide Fractions</span>
      <span class="pill">Score: <span id="score" class="mono">0</span></span>
    </h1>
    <div class="body">
      <div class="row">
        <span class="pill">Session: <span id="sidLabel" class="mono">—</span></span>
        <span class="pill">Time left: <span id="tLeft" class="mono">—</span></span>
        <span class="pill">Q: <span id="qIdx" class="mono">0</span>/10</span>
        <span class="spacer"></span>
        <span class="pill">Auth: <span id="authStatus" class="mono">Signing in…</span></span>
      </div>

      <div class="hr"></div>

      <div class="qBox">
        <div class="qText" id="qText">Waiting to start…</div>
        <div class="spacer"></div>
        <div class="pill">This Q: <span id="qTimer" class="mono">—</span></div>
      </div>

      <div class="answerArea">
        <div class="ansMixed">
          <div>
            <div class="muted" style="font-size:12px;margin-bottom:6px">Whole</div>
            <div id="inWhole" class="box boxWhole"> </div>
          </div>

          <div>
            <div class="muted" style="font-size:12px;margin-bottom:6px">Fraction</div>
            <div class="fracInputs">
              <div id="inNum" class="box boxSmall"> </div>
              <div class="fracBar2"></div>
              <div id="inDen" class="box boxSmall"> </div>
            </div>
          </div>
        </div>

        <button id="btnSubmit" disabled>Submit</button>
      </div>

      <div class="simplestLine">All answers must be given in the simplest form.</div>

      <div class="padWrap">
        <div class="pad" id="pad"></div>
        <div class="row">
          <button class="secondary" id="btnClear">Clear</button>
          <button class="secondary" id="btnBack">Backspace</button>
          <span class="spacer"></span>
          <button class="secondary" id="btnRules">Rules</button>
        </div>
      </div>

      <div class="toast" id="toast"></div>
      <div class="hint" id="hint"></div>
    </div>
  </div>
</div>

<!-- Join modal -->
<div class="modal" id="joinModal">
  <div class="modalBox">
    <div class="modalHead">Join session</div>
    <div class="modalBody">
      <div class="pill">Session: <strong id="sidLabel2">—</strong></div>
      <div class="hint" id="joinHint">Loading class list…</div>
      <div style="margin-top:10px">
        <select id="nameSelect" disabled>
          <option value="">Loading…</option>
        </select>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnJoin" disabled>Join</button>
        <button class="secondary" id="btnRefresh">Refresh</button>
      </div>
    </div>
  </div>
</div>

<!-- Rules modal -->
<div class="modal" id="rulesModal" style="display:none">
  <div class="modalBox">
    <div class="modalHead">Rules</div>
    <div class="modalBody">
      <div class="muted" style="font-size:13px; line-height:1.45">
        <div>• Answer 10 questions as quickly and accurately as you can.</div>
        <div>• Wrong answers reduce your score (penalty set by teacher).</div>
        <div>• All answers must be in the simplest form.</div>
        <div>• If the answer is a mixed number, write it as a mixed number (not an improper fraction).</div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnCloseRules">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getDatabase, ref, get, set, update, onValue, off, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // --- Firebase config (same as teacher) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBJA0S1lMftbIImWuIvrY84mtEZ3NeO-mA",
    authDomain: "multiply-and-divide-fractions.firebaseapp.com",
    databaseURL: "https://multiply-and-divide-fractions-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "multiply-and-divide-fractions",
    storageBucket: "multiply-and-divide-fractions.firebasestorage.app",
    messagingSenderId: "641613369936",
    appId: "1:641613369936:web:8ca6dbc66b015bf9087755"
  };

  // --- DOM ---
  const $ = (id)=>document.getElementById(id);
  const sid = new URLSearchParams(location.search).get("sid") || "";
  $("sidLabel").textContent = sid || "(missing sid)";
  $("sidLabel2").textContent = sid || "(missing sid)";

  const authStatus = $("authStatus");
  const scoreEl = $("score");
  const tLeftEl = $("tLeft");
  const qIdxEl = $("qIdx");
  const qTimerEl = $("qTimer");
  const qTextEl = $("qText");
  const toast = $("toast");
  const hint = $("hint");

  const joinModal = $("joinModal");
  const joinHint = $("joinHint");
  const nameSelect = $("nameSelect");
  const btnJoin = $("btnJoin");
  const btnRefresh = $("btnRefresh");

  const rulesModal = $("rulesModal");
  const btnRules = $("btnRules");
  const btnCloseRules = $("btnCloseRules");

  const inWhole = $("inWhole");
  const inNum = $("inNum");
  const inDen = $("inDen");
  const btnSubmit = $("btnSubmit");
  const btnClear = $("btnClear");
  const btnBack = $("btnBack");

  // --- State ---
  let app, auth, db;
  let uid = "";
  let session = null;
  let playerName = "";
  let score = 0;
  let answered = 0;
  let quiz = [];
  let qIndex = 0;

  let overallEndMs = 0;
  let overallTick = null;

  let qStartMs = 0;
  let qTick = null;

  let wrongPenalty = 20;

  // input focus
  let activeField = "whole"; // "whole" | "num" | "den"
  let wStr="", nStr="", dStr="";

  // sounds (WebAudio)
  let audioCtx = null;
  function beep(freq, durMs, type="sine", gain=0.05){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = 0;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0);
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(gain, t0 + 0.01);
      g.gain.linearRampToValueAtTime(0, t0 + durMs/1000);
      o.stop(t0 + durMs/1000 + 0.02);
    }catch(e){}
  }
  function sfxCorrect(){
    beep(880, 90, "triangle", 0.06);
    setTimeout(()=>beep(1320, 110, "triangle", 0.06), 90);
  }
  function sfxWrong(){
    beep(180, 180, "sawtooth", 0.05);
  }

  function setToast(msg, cls){
    toast.textContent = msg || "";
    toast.className = "toast" + (cls ? " " + cls : "");
  }

  function setActive(field){
    activeField = field;
    inWhole.classList.toggle("active", field==="whole");
    inNum.classList.toggle("active", field==="num");
    inDen.classList.toggle("active", field==="den");
  }
  function redrawInputs(){
    inWhole.textContent = wStr || " ";
    inNum.textContent = nStr || " ";
    inDen.textContent = dStr || " ";
    updateSubmitEnabled();
  }
  function clearInputs(){
    wStr=""; nStr=""; dStr="";
    redrawInputs();
  }
  function backspace(){
    if(activeField==="whole" && wStr) wStr = wStr.slice(0,-1);
    if(activeField==="num" && nStr) nStr = nStr.slice(0,-1);
    if(activeField==="den" && dStr) dStr = dStr.slice(0,-1);
    redrawInputs();
  }
  function addDigit(d){
    const maxLen = 3;
    if(activeField==="whole"){
      if(wStr.length<maxLen) wStr += d;
    }else if(activeField==="num"){
      if(nStr.length<maxLen) nStr += d;
    }else{
      if(dStr.length<maxLen) dStr += d;
    }
    redrawInputs();
  }

  // Coherent entry: allow any format (whole-only, frac-only, mixed) so no “answer type giveaway”
  function updateSubmitEnabled(){
    const hasW = wStr.trim() !== "";
    const hasN = nStr.trim() !== "";
    const hasD = dStr.trim() !== "";
    const coherent =
      (hasW && !hasN && !hasD) ||
      (!hasW && hasN && hasD) ||
      (hasW && hasN && hasD);
    // Denominator must not be 0 if present
    const denOk = !hasD || (parseInt(dStr,10) !== 0);
    btnSubmit.disabled = !(coherent && denOk && session && session.active);
  }

  // --- Fraction helpers ---
  function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ const t=a%b; a=b; b=t; } return a||1; }
  function simp(n,d){
    if(d<0){ n=-n; d=-d; }
    const g=gcd(n,d);
    return {n:n/g, d:d/g};
  }
  function fracEq(a,b){ return a.n===b.n && a.d===b.d; }

  function parseEntry(){
    const hasW = wStr.trim() !== "";
    const hasN = nStr.trim() !== "";
    const hasD = dStr.trim() !== "";
    if(hasW && !hasN && !hasD){
      const w = parseInt(wStr,10);
      if(!Number.isFinite(w)) return { ok:false };
      return { ok:true, kind:"whole", w };
    }
    if(!hasW && hasN && hasD){
      const n=parseInt(nStr,10), d=parseInt(dStr,10);
      if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return { ok:false };
      return { ok:true, kind:"frac", f:simp(n,d), raw:{n,d} };
    }
    if(hasW && hasN && hasD){
      const w=parseInt(wStr,10), n=parseInt(nStr,10), d=parseInt(dStr,10);
      if(!Number.isFinite(w)||!Number.isFinite(n)||!Number.isFinite(d)||d===0) return { ok:false };
      return { ok:true, kind:"mixed", w, f:simp(n,d), raw:{n,d} };
    }
    return { ok:false };
  }
  function isSimplest(rawN, rawD){
    if(rawD===0) return false;
    const g=gcd(rawN, rawD);
    return g===1;
  }

  // --- Quiz generator (from your existing logic, kept) ---
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function makeProperFrac(){
    const d = randInt(3,12);
    const n = randInt(1,d-1);
    return simp(n,d);
  }
  function fracFromInt(w){ return {n:w, d:1}; }
  function fracMul(a,b){ return simp(a.n*b.n, a.d*b.d); }
  function fracDiv(a,b){ return simp(a.n*b.d, a.d*b.n); }

  function capAnswer(ans){
    // keep answers manageable: numerator/denom <= 144 and whole <= 30 (approx)
    if(ans.d === 0) return false;
    if(Math.abs(ans.n) > 3600) return false;
    if(ans.d > 3600) return false;
    return true;
  }

  // needsSimplify helpers (same idea as your v1)
  function needsSimplify_mul(A,B){ return gcd(A.n,B.d)>1 || gcd(B.n,A.d)>1; }
  function needsSimplify_wMulF(W,B){ return gcd(W,B.d)>1; }
  function needsSimplify_fDivW(A,W){ return gcd(A.n,W)>1; }
  function needsSimplify_fDivF(A,B){ return gcd(A.n,B.n)>1 || gcd(A.d,B.d)>1; }
  function needsSimplify_wDivF(W,B){ return gcd(W,B.n)>1; }

  function willBeMixed_fDivW(A,W){
    // A/W -> n/(dW), mixed impossible if proper
    return false;
  }
  function willBeMixed_fDivF(A,B){
    // proper ÷ proper may be >1; detect
    return (A.n*B.d) >= (A.d*B.n);
  }
  function willBeMixed_wDivF(W,B){
    return (W*B.d) >= B.n;
  }

  function toMixed(fr){
    const whole = Math.floor(fr.n / fr.d);
    const rem = fr.n - whole*fr.d;
    return { w: whole, f: simp(rem, fr.d) };
  }

  function pack(type, expr, ans, mustSimplify, mixed){
    // Determine expected strict format
    let expectedKind = "frac";
    let expected = { kind:"frac", f: ans };
    if(ans.d === 1){
      expectedKind = "whole";
      expected = { kind:"whole", w: ans.n };
    }else if(mixed){
      const m = toMixed(ans);
      expectedKind = "mixed";
      expected = { kind:"mixed", w: m.w, f: m.f };
    }
    return { type, expr, ans, mustSimplify, mixed, expected };
  }

  function genQuestion(type, mustSimplify, mustMixed){
    for(let tries=0; tries<4000; tries++){
      let A,B,W, expr, ans;
      if(type==="FxF"){
        A=makeProperFrac(); B=makeProperFrac();
        ans = fracMul(A,B);
        if(mustMixed) continue;
        if(mustSimplify && !needsSimplify_mul(A,B)) continue;
        if(!mustSimplify && needsSimplify_mul(A,B)) continue;
        if(!capAnswer(ans)) continue;
        expr = {a:A, op:"×", b:B, w:null};
        return pack(type, expr, ans, mustSimplify, false);
      }
      if(type==="WxF"){
        W = randInt(4,18);
        B=makeProperFrac();
        ans = fracMul(fracFromInt(W), B);
        const mixed = false;
        if(mustMixed) continue;
        if(mustSimplify && !needsSimplify_wMulF(W,B)) continue;
        if(!mustSimplify && needsSimplify_wMulF(W,B)) continue;
        if(!capAnswer(ans)) continue;
        expr = {w:W, op:"×", b:B, a:null};
        return pack(type, expr, ans, mustSimplify, mixed);
      }
      if(type==="FdivW"){
        A=makeProperFrac(); W=randInt(3,12);
        ans = fracDiv(A, fracFromInt(W));
        if(mustMixed) continue;
        if(mustSimplify && !needsSimplify_fDivW(A,W)) continue;
        if(!mustSimplify && needsSimplify_fDivW(A,W)) continue;
        if(!capAnswer(ans)) continue;
        expr = {a:A, op:"÷", w:W, b:null};
        return pack(type, expr, ans, mustSimplify, false);
      }
      if(type==="FdivF"){
        A=makeProperFrac(); B=makeProperFrac();
        ans = fracDiv(A,B);
        const mixed = willBeMixed_fDivF(A,B);
        if(mustMixed && !mixed) continue;
        if(!mustMixed && mixed) continue;
        if(mustSimplify && !needsSimplify_fDivF(A,B)) continue;
        if(!mustSimplify && needsSimplify_fDivF(A,B)) continue;
        if(!capAnswer(ans)) continue;
        expr = {a:A, op:"÷", b:B, w:null};
        return pack(type, expr, ans, mustSimplify, mixed);
      }
      if(type==="WdivF"){
        W=randInt(4,18);
        B=makeProperFrac();
        ans = fracDiv(fracFromInt(W), B);
        const mixed = willBeMixed_wDivF(W,B);
        if(mustMixed && !mixed) continue;
        if(!mustMixed && mixed) continue;
        if(mustSimplify && !needsSimplify_wDivF(W,B)) continue;
        if(!mustSimplify && needsSimplify_wDivF(W,B)) continue;
        if(!capAnswer(ans)) continue;
        expr = {w:W, op:"÷", b:B, a:null};
        return pack(type, expr, ans, mustSimplify, mixed);
      }
    }
    // fallback (should never happen)
    return pack("FxF", {a:{n:1,d:2},op:"×",b:{n:1,d:3},w:null}, simp(1,6), false, false);
  }

  function buildQuiz(){
    const types = ["FxF","FxF","WxF","WxF","FdivW","FdivW","FdivF","FdivF","WdivF","WdivF"];
    // choose which ones must simplify (5) and which must be mixed (3)
    const idxs = [...Array(10)].map((_,i)=>i);
    shuffle(idxs);
    const simpSet = new Set(idxs.slice(0,5));
    const mixedSet = new Set(idxs.slice(5,8)); // 3 mixed
    const qs = [];
    for(let i=0;i<10;i++){
      const q = genQuestion(types[i], simpSet.has(i), mixedSet.has(i));
      qs.push(q);
    }
    shuffle(qs);
    return qs;
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function renderFrac(f){
    return `<span class="frac"><span class="top">${f.n}</span><span class="bar"></span><span class="bot">${f.d}</span></span>`;
  }
  function renderExpr(q){
    const e = q.expr;
    const left = e.w!=null ? `<span>${e.w}</span>` : renderFrac(e.a);
    const right = e.w!=null && e.a==null ? renderFrac(e.b) : (e.w!=null ? `<span>${e.w}</span>` : renderFrac(e.b));
    // For mixed types we store in different fields; handle cases
    if(q.type==="WxF" || q.type==="WdivF"){
      return `<span>${e.w}</span> <span>${escapeHtml(e.op)}</span> ${renderFrac(e.b)}`;
    }
    if(q.type==="FdivW"){
      return `${renderFrac(e.a)} <span>${escapeHtml(e.op)}</span> <span>${e.w}</span>`;
    }
    return `${renderFrac(e.a)} <span>${escapeHtml(e.op)}</span> ${renderFrac(e.b)}`;
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function startQuestion(){
    clearInputs();
    setActive("whole");
    setToast("", "");
    hint.textContent = "";

    const q = quiz[qIndex];
    qTextEl.innerHTML = renderExpr(q);
    qIdxEl.textContent = String(qIndex+1);

    qStartMs = Date.now();
    if(qTick) clearInterval(qTick);
    qTick = setInterval(()=>{
      const s = Math.max(0, Math.floor((Date.now() - qStartMs)/1000));
      qTimerEl.textContent = s + "s";
    }, 250);
    qTimerEl.textContent = "0s";
  }

  function endGame(){
    if(qTick) clearInterval(qTick);
    if(overallTick) clearInterval(overallTick);
    btnSubmit.disabled = true;
    hint.textContent = "Done! You may close this tab.";
  }

  function updateOverallTimer(){
    const left = Math.max(0, Math.ceil((overallEndMs - Date.now())/1000));
    const m = Math.floor(left/60);
    const s = left%60;
    tLeftEl.textContent = m + ":" + String(s).padStart(2,"0");
    if(left <= 0){
      session.active = false;
      hint.textContent = "Time is up!";
      endGame();
    }
  }

  // --- Firebase / session loading ---
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getDatabase(app);

  if(!sid){
    joinHint.textContent = "Missing session code. Please scan the teacher QR code.";
    nameSelect.innerHTML = `<option value="">(Missing sid)</option>`;
    return;
  }

  async function loadSession(){
    joinHint.textContent = "Loading class list…";
    nameSelect.disabled = true;
    btnJoin.disabled = true;

    if(!sid){
      joinHint.textContent = "Missing session code. Please rescan the QR code.";
      nameSelect.innerHTML = `<option value="">(Missing session)</option>`;
      return;
    }

    const pubRef = ref(db, `sessions/${sid}/public`);

    try{
      const snap = await get(pubRef);
      if(!snap.exists()){
        joinHint.textContent = "Session not found. Please rescan the QR code.";
        nameSelect.innerHTML = `<option value="">(Session not found)</option>`;
        return;
      }
      session = snap.val();
      wrongPenalty = Number(session.wrongPenalty || 20);

      // Setup overall time based on teacher config (best-effort)
      const total = Number(session.timeLimitSec || 720);
      overallEndMs = Date.now() + total*1000;

      // Listen for roster updates (helps if teacher just started session)
      onValue(pubRef, (s)=>{
        if(!s.exists()) return;
        session = s.val();
        wrongPenalty = Number(session.wrongPenalty || wrongPenalty);
        const roster = Array.isArray(session.roster) ? session.roster : [];

        if(roster.length){
          const options = [`<option value="">Select your name…</option>`]
            .concat(roster.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`));
          nameSelect.innerHTML = options.join("");
          nameSelect.disabled = false;
          joinHint.textContent = "Select your name, then press Join.";
        }else{
          nameSelect.innerHTML = `<option value="">(Roster not loaded yet)</option>`;
          nameSelect.disabled = true;
          joinHint.textContent = "Roster not loaded yet. Ask your teacher to (re)start the session.";
        }
        btnJoin.disabled = !nameSelect.value;
      }, (err)=>{
        console.error(err);
        joinHint.textContent = "Could not listen for roster (rules/network). Refresh and try again.";
      });

    }catch(err){
      console.error(err);
      const code = err?.code || "";
      const msg  = err?.message || String(err);
      if(String(code).includes("permission") || String(msg).toLowerCase().includes("permission")){
        joinHint.textContent = "Permission error loading roster. If you opened this inside a camera/QR preview browser, tap Share → Open in Safari/Chrome, then try again.";
      }else{
        joinHint.textContent = "Error loading session. Please refresh and try again.";
      }
      nameSelect.innerHTML = `<option value="">(Could not load)</option>`;
      nameSelect.disabled = true;
      btnJoin.disabled = true;
      authStatus.textContent = "Problem loading session";
    }
  }

  nameSelect.addEventListener("change", ()=>{
    btnJoin.disabled = !nameSelect.value;
  });


  btnRefresh.addEventListener("click", ()=>{
    location.reload();
  });

  btnRules.addEventListener("click", ()=>{
    rulesModal.style.display = "flex";
  });
  btnCloseRules.addEventListener("click", ()=>{
    rulesModal.style.display = "none";
  });

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      uid = user.uid;
      authStatus.textContent = "Signed in (anon)";
      await loadSession();
    }else{
      authStatus.textContent = "Signing in…";
    }
  });

  // If anon sign-in hangs (common in some in-app QR/camera browsers), show a helpful hint.
  let authWatchdogFired = false;
  setTimeout(()=>{
    if(uid || authWatchdogFired) return;
    // Still not signed in after a few seconds
    authWatchdogFired = true;
    joinHint.textContent = "If you opened this inside a camera/QR preview browser, tap Share/⋯ → Open in Safari/Chrome, then try again.";
  }, 5000);


  signInAnonymously(auth).catch(err=>{
    authStatus.textContent = "Auth error";
    joinHint.textContent = "Auth error: " + (err?.code || err?.message || String(err));
    console.error(err);
  });

  async function upsertPlayerOnJoin(name){
    const playerRef = ref(db, `sessions/${sid}/players/${uid}`);
    const now = Date.now();

    await runTransaction(playerRef, (cur)=>{
      if(cur && typeof cur==="object"){
        // Preserve scores (fixes “disappearing” after refresh)
        const best = Number(cur.bestScore||0);
        const curScore = Number(cur.currentScore||0);
        const ans = Number(cur.answered||0);
        return {
          ...cur,
          name,
          lastSeen: now,
          joinedAt: cur.joinedAt || now,
          currentScore: curScore,
          bestScore: best,
          answered: ans
        };
      }
      return {
        name,
        joinedAt: now,
        lastSeen: now,
        currentScore: 0,
        bestScore: 0,
        answered: 0
      };
    });
  }

  async function pushScore(){
    const playerRef = ref(db, `sessions/${sid}/players/${uid}`);
    const now = Date.now();
    await runTransaction(playerRef, (cur)=>{
      const curObj = (cur && typeof cur==="object") ? cur : {};
      const curScore = Number(score||0);
      const best = Math.max(Number(curObj.bestScore||0), curScore);
      return {
        ...curObj,
        name: playerName || curObj.name || "",
        lastSeen: now,
        currentScore: curScore,
        bestScore: best,
        answered: answered
      };
    });
  }

  // heartbeat so teacher sees “last seen”
  setInterval(()=>{
    if(!uid || !playerName || !sid) return;
    update(ref(db, `sessions/${sid}/players/${uid}`), { lastSeen: Date.now() }).catch(()=>{});
  }, 8000);

  btnJoin.addEventListener("click", async ()=>{
    const nm = nameSelect.value;
    if(!nm) return;
    playerName = nm;

    try{
      await upsertPlayerOnJoin(playerName);
    }catch(e){
      joinHint.textContent = "Could not join (network/rules). Refresh and try again.";
      console.error(e);
      return;
    }

    // Start game
    joinModal.style.display = "none";
    score = 0; answered = 0; qIndex = 0;
    scoreEl.textContent = "0";
    quiz = buildQuiz();
    qIdxEl.textContent = "1";
    session.active = !!session.active;

    // overall timer
    if(overallTick) clearInterval(overallTick);
    overallTick = setInterval(updateOverallTimer, 250);
    updateOverallTimer();

    startQuestion();
    await pushScore();
  });

  // --- Keypad UI ---
  const pad = $("pad");
  const keys = [
    "7","8","9","Whole","Num","Den",
    "4","5","6","←","Clear","",
    "1","2","3","0","Submit",""
  ];
  // Build keypad: digits + field selection + actions
  function makeKey(label, cls=""){
    const d=document.createElement("div");
    d.className="k " + cls;
    d.textContent=label;
    return d;
  }
  function buildPad(){
    pad.innerHTML="";
    const add = (el)=>pad.appendChild(el);

    // Row 1
    ["7","8","9"].forEach(k=>{ const el=makeKey(k); el.onclick=()=>addDigit(k); add(el); });
    const kw=makeKey("Whole","wide"); kw.onclick=()=>setActive("whole"); add(kw);
    const kn=makeKey("Num","wide");   kn.onclick=()=>setActive("num"); add(kn);
    const kd=makeKey("Den","wide");   kd.onclick=()=>setActive("den"); add(kd);

    // Row 2
    ["4","5","6"].forEach(k=>{ const el=makeKey(k); el.onclick=()=>addDigit(k); add(el); });
    const bk=makeKey("⌫","wide bad"); bk.onclick=backspace; add(bk);
    const cl=makeKey("Clear","wide bad"); cl.onclick=clearInputs; add(cl);

    // Row 3
    ["1","2","3","0"].forEach(k=>{ const el=makeKey(k); el.onclick=()=>addDigit(k); add(el); });
    const sb=makeKey("Submit","wide good"); sb.onclick=()=>btnSubmit.click(); add(sb);
  }
  buildPad();

  inWhole.addEventListener("click", ()=>setActive("whole"));
  inNum.addEventListener("click", ()=>setActive("num"));
  inDen.addEventListener("click", ()=>setActive("den"));
  btnClear.addEventListener("click", clearInputs);
  btnBack.addEventListener("click", backspace);

  // --- Marking (strict format; but no format-gating) ---
  function markAnswer(){
    const q = quiz[qIndex];
    const entry = parseEntry();
    if(!entry.ok){
      setToast("Invalid answer entry.", "bad");
      sfxWrong();
      return false;
    }

    // strict simplest form check (for fraction parts)
    if(entry.kind==="frac"){
      if(!isSimplest(entry.raw.n, entry.raw.d)){
        setToast("Not in simplest form.", "bad");
        sfxWrong();
        return false;
      }
    }
    if(entry.kind==="mixed"){
      // mixed fractional part must be proper and simplest
      if(entry.raw.d === 0 || entry.raw.n <= 0 || entry.raw.n >= entry.raw.d){
        setToast("Mixed number needs a proper fraction part.", "bad");
        sfxWrong();
        return false;
      }
      if(!isSimplest(entry.raw.n, entry.raw.d)){
        setToast("Not in simplest form.", "bad");
        sfxWrong();
        return false;
      }
    }

    // strict format matching
    const exp = q.expected;
    let correct = false;

    if(exp.kind==="whole"){
      correct = (entry.kind==="whole" && entry.w === exp.w);
    }else if(exp.kind==="frac"){
      correct = (entry.kind==="frac" && fracEq(entry.f, exp.f));
    }else{
      // mixed
      correct = (entry.kind==="mixed" && entry.w === exp.w && fracEq(entry.f, exp.f));
    }

    if(correct){
      const tSec = Math.max(1, (Date.now() - qStartMs)/1000);
      // Scoring: base + speed bonus (tuneable)
      const base = 100;
      const speedBonus = Math.max(0, Math.round(60 - tSec*6)); // quicker => more bonus
      score += (base + speedBonus);
      answered += 1;

      setToast("Correct!", "good");
      sfxCorrect();
      return true;
    }else{
      score = Math.max(0, score - wrongPenalty);
      setToast("Incorrect.", "bad");
      sfxWrong();
      return true; // still an attempt
    }
  }

  async function nextStep(){
    scoreEl.textContent = String(score);
    await pushScore();

    qIndex += 1;
    if(qIndex >= 10){
      endGame();
      setToast("Finished!", "good");
      return;
    }
    startQuestion();
  }

  btnSubmit.addEventListener("click", async ()=>{
    if(btnSubmit.disabled) return;
    if(!session || !session.active){
      setToast("Session is not active.", "bad");
      return;
    }
    const attempted = markAnswer();
    if(!attempted) return;
    await nextStep();
  });

  // init input visuals
  setActive("whole");
  redrawInputs();

</script>
</body>
</html>
