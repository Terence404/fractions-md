<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student – Multiply & Divide Fractions</title>
<style>
  :root{
    --bg:#0b1020; --card:#111a33; --text:#eaf0ff; --muted:rgba(234,240,255,.72);
    --line:rgba(234,240,255,.14); --accent:#66d9ff; --good:#39d98a; --bad:#ff6b6b;
    --shadow:0 12px 30px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:radial-gradient(1200px 600px at 10% 0%, #1a2a5a 0%, #0b1020 55%, #060914 100%);color:var(--text); min-height:100vh;}
  .wrap{max-width:980px; margin:0 auto; padding:18px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
  .card h2{margin:0; padding:14px 16px; font-size:18px; background:rgba(0,0,0,.18); border-bottom:1px solid var(--line);}
  .body{padding:14px 16px}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid rgba(234,240,255,.16); border-radius:999px; background:rgba(0,0,0,.18); color:var(--muted); font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .mini{font-size:12px; color:var(--muted)}
  select,button{font:inherit}
  select{width:100%; padding:12px 12px; border-radius:14px; border:1px solid rgba(234,240,255,.16); background:rgba(0,0,0,.20); color:var(--text); outline:none}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:900; cursor:pointer; background:rgba(234,240,255,.14); color:var(--text); border:1px solid rgba(234,240,255,.16)}
  button.primary{background:var(--accent); color:#001018; border:none}
  button:disabled{opacity:.45; cursor:not-allowed}
  .debug{
    margin-top:12px;
    padding:10px 12px;
    border:1px dashed rgba(234,240,255,.20);
    border-radius:14px;
    background:rgba(0,0,0,.18);
    font-size:12px;
    color:rgba(234,240,255,.85);
    white-space:pre-wrap;
    word-break:break-word;
  }
  .ok{color:var(--good); font-weight:900}
  .err{color:var(--bad); font-weight:900}
  .build{position:fixed; right:10px; bottom:8px; font-size:12px; color:rgba(234,240,255,.35)}
</style>

<!-- Firebase compat scripts with onerror hooks -->
<script>
  // Build marker (visible even if everything else breaks)
  window.__BUILD = "C2";
</script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js" onerror="window.__fbErr='firebase-app-compat failed to load';"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js" onerror="window.__fbErr='firebase-auth-compat failed to load';"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js" onerror="window.__fbErr='firebase-database-compat failed to load';"></script>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Join session</h2>
    <div class="body">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Session: <strong id="sidLabel" class="mono">—</strong></div>
        <div class="pill">Auth: <strong id="authLabel" class="mono">—</strong></div>
      </div>

      <p class="mini" style="margin-top:12px">Select your name. Please choose your own name only.</p>
      <select id="nameSelect" disabled>
        <option>Loading…</option>
      </select>

      <div class="row" style="margin-top:12px">
        <button id="joinBtn" class="primary" disabled>Join</button>
        <button id="refreshBtn">Refresh</button>
      </div>

      <div class="mini" id="hint" style="margin-top:10px"></div>

      <div class="debug" id="debug">build C2 (debug mode)
JS: starting…</div>
    </div>
  </div>
</div>

<div class="build">build C2</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const dbg = $("debug");
  const hint = $("hint");
  const sidLabel = $("sidLabel");
  const authLabel = $("authLabel");
  const nameSelect = $("nameSelect");
  const joinBtn = $("joinBtn");
  const refreshBtn = $("refreshBtn");

  function log(line){
    dbg.textContent += "\n" + line;
  }
  function setHint(msg, cls){
    hint.textContent = msg || "";
    hint.className = "mini " + (cls||"");
  }

  // Global error hooks so you don't need a console on iPad
  window.addEventListener("error", (e)=>{
    log("[JS ERROR] " + (e.message || e.error || "unknown"));
  });
  window.addEventListener("unhandledrejection", (e)=>{
    log("[PROMISE ERROR] " + (e.reason?.message || e.reason || "unknown"));
  });

  // Parse SID from query OR hash, and also tolerate QR scanners that strip query by putting sid in path fragment
  function getSid(){
    try{
      const usp = new URLSearchParams(location.search);
      const q = (usp.get("sid")||"").trim();
      if(q) return q;
      const h = (location.hash||"").replace(/^#/, "");
      const usp2 = new URLSearchParams(h);
      const q2 = (usp2.get("sid")||"").trim();
      if(q2) return q2;
      // fallback: sid=XXXXX anywhere
      const m = (location.href||"").match(/[?&#]sid=([A-Za-z0-9]+)/);
      return m ? m[1] : "";
    }catch{
      return "";
    }
  }

  const sid = getSid();
  sidLabel.textContent = sid || "(missing)";
  log("URL: " + location.href);
  log("Detected sid: " + (sid || "(missing)"));

  if(!sid){
    nameSelect.innerHTML = '<option>No session id (scan QR again)</option>';
    nameSelect.disabled = true;
    setHint("Missing session code. Scan the QR from your teacher.", "err");
    return;
  }

  // If Firebase scripts failed to load, explain clearly
  setTimeout(()=>{
    if(window.__fbErr){
      authLabel.textContent = "Firebase blocked";
      setHint("Firebase scripts did not load. This Wi‑Fi/network may be blocking gstatic/firebasejs.", "err");
      log("[BLOCKED] " + window.__fbErr);
    }
  }, 1200);

  if(!window.firebase){
    // Give scripts a moment; if still missing, fail loudly.
    setTimeout(()=>{
      if(!window.firebase){
        authLabel.textContent = "Firebase missing";
        nameSelect.innerHTML = '<option>Firebase not available</option>';
        nameSelect.disabled = true;
        joinBtn.disabled = true;
        setHint("Firebase not available. Try mobile data or a different network.", "err");
        log("[FAIL] window.firebase is undefined");
      }
    }, 1500);
    return;
  }

  // Firebase config (matches your teacher.html)
  const firebaseConfig = {
    apiKey: "AIzaSyBJA0S1lMftbIImWuIvrY84mtEZ3NeO-mA",
    authDomain: "multiply-and-divide-fractions.firebaseapp.com",
    databaseURL: "https://multiply-and-divide-fractions-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "multiply-and-divide-fractions",
    storageBucket: "multiply-and-divide-fractions.firebasestorage.app",
    messagingSenderId: "641613369936",
    appId: "1:641613369936:web:8ca6dbc66b015bf9087755"
  };

  try{
    if(!firebase.apps || firebase.apps.length===0){
      firebase.initializeApp(firebaseConfig);
      log("Firebase initialized.");
    }else{
      log("Firebase already initialized.");
    }
  }catch(e){
    log("[INIT ERROR] " + (e?.message || e));
  }

  const auth = firebase.auth();
  const db = firebase.database();

  let authedUser = null;
  let rosterLoaded = false;
  let roster = [];

  function updateJoinEnabled(){
    const hasName = !!(nameSelect.value && nameSelect.value.trim());
    joinBtn.disabled = !(hasName && authedUser);
  }

  function populateSelect(names){
    roster = Array.isArray(names) ? names.slice() : [];
    if(!roster.length){
      nameSelect.innerHTML = '<option>(No names available)</option>';
      nameSelect.disabled = true;
      setHint("No class list found for this session. Ask your teacher to start a new session.", "err");
      log("[ROSTER] Empty / missing roster.");
      return;
    }
    nameSelect.innerHTML = roster.map(n=>{
      const safe = String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      return `<option value="${safe}">${safe}</option>`;
    }).join("");
    nameSelect.disabled = false;
    setHint("Select your name, then press Join.", "ok");
    log("[ROSTER] Loaded " + roster.length + " names.");
    updateJoinEnabled();
  }

  async function loadRosterOnce(){
    rosterLoaded = false;
    setHint("Loading class list…", "");
    nameSelect.disabled = true;
    nameSelect.innerHTML = '<option>Loading…</option>';
    log("[DB] Reading sessions/" + sid + "/public");

    try{
      const snap = await db.ref("sessions/" + sid + "/public").get();
      if(!snap.exists()){
        populateSelect([]);
        log("[DB] Session public not found (snap.exists=false).");
        return;
      }
      const pub = snap.val() || {};
      log("[DB] public keys: " + Object.keys(pub).join(", "));
      const names = pub.roster || [];
      rosterLoaded = true;
      populateSelect(Array.isArray(names) ? names : Object.values(names||{}));
    }catch(e){
      const msg = (e?.code ? (e.code + " ") : "") + (e?.message || String(e));
      setHint("Cannot load class list (permission/network).", "err");
      nameSelect.innerHTML = '<option>(Cannot load class list)</option>';
      nameSelect.disabled = true;
      joinBtn.disabled = true;
      log("[DB ERROR] " + msg);
    }
  }

  // Start auth
  authLabel.textContent = "Signing in…";
  const authWatch = setTimeout(()=>{
    if(!authedUser){
      setHint("Still signing in… If this was opened inside a QR/camera preview browser, use Share → Open in Safari/Chrome.", "err");
      log("[AUTH] Still not signed in after 6s.");
    }
  }, 6000);

  auth.onAuthStateChanged(async (u)=>{
    authedUser = u || null;
    if(u){
      authLabel.textContent = "anon";
      log("[AUTH] Signed in: " + u.uid.slice(0,8) + "…");
      clearTimeout(authWatch);
      updateJoinEnabled();
      // If roster hasn't loaded yet, or last attempt failed, try again now that auth exists
      if(!rosterLoaded){
        await loadRosterOnce();
      }
    }else{
      authLabel.textContent = "Signed out";
      log("[AUTH] Signed out");
      updateJoinEnabled();
    }
  });

  auth.signInAnonymously().catch((e)=>{
    const msg = (e?.code ? (e.code + " ") : "") + (e?.message || String(e));
    authLabel.textContent = "Auth error";
    setHint("Cannot sign in. Try opening in Safari/Chrome.", "err");
    log("[AUTH ERROR] " + msg);
  });

  // Try load roster immediately (may succeed even before auth, depending on rules)
  loadRosterOnce();

  nameSelect.addEventListener("change", updateJoinEnabled);

  refreshBtn.addEventListener("click", ()=>{
    log("[UI] Refresh clicked");
    loadRosterOnce();
  });

  joinBtn.addEventListener("click", async ()=>{
    if(!authedUser) { setHint("Still signing in…", "err"); return; }
    const chosen = (nameSelect.value||"").trim();
    if(!chosen){ setHint("Please choose your name.", "err"); return; }

    setHint("Joining…", "");
    log("[JOIN] name=" + chosen);

    try{
      // mark player in DB
      const uid = authedUser.uid;
      const playerRef = db.ref(`sessions/${sid}/players/${uid}`);
      await playerRef.update({
        name: chosen,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        lastSeen: firebase.database.ServerValue.TIMESTAMP,
        currentScore: 0,
        bestScore: 0,
        answered: 0
      });
      setHint("Joined! You can now start when the session begins.", "ok");
      log("[JOIN] Player written.");
      // At this point, your existing game UI (in your real student.html) would show.
      // This debug file only validates join/roster/auth.
    }catch(e){
      const msg = (e?.code ? (e.code + " ") : "") + (e?.message || String(e));
      setHint("Join failed (permission/network).", "err");
      log("[JOIN ERROR] " + msg);
    }
  });

})();
</script>
</body>
</html>
